// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  MERCHANT
  ADMIN
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum TransferStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum WithdrawalStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum BridgeTransactionStatus {
  PENDING
  CONFIRMING
  COMPLETED
  FAILED
}

enum NotificationType {
  SYSTEM
  ACTION
  SECURITY
}

model User {
  id              String         @id @default(uuid())
  userId          String         @unique
  stellarAddress  String         @unique
  pinHash         String
  role            Role           @default(USER)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  profile         UserProfile?
  payments        Payment[]
  transfersFrom   Transfer[]     @relation("TransfersFrom")
  transfersTo     Transfer[]     @relation("TransfersTo")
  withdrawals     Withdrawal[]
  notifications   Notification[]
  auditLogs       AuditLog[]
  balances        Balance[]
}

model UserProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [userId])
  displayName String
  avatarUrl   String?
  bio         String?
  country     String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Merchant {
  id              String    @id @default(uuid())
  merchantId      String    @unique
  vaultAddress    String
  settlementAsset String
  active          Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  payments        Payment[]
}

model Payment {
  id            String        @id @default(uuid())
  txHash        String?       @unique
  fromAddress   String
  merchantId    String
  merchant      Merchant      @relation(fields: [merchantId], references: [merchantId])
  sendAsset     String
  sendAmount    BigInt
  receiveAmount BigInt?
  status        PaymentStatus @default(PENDING)
  memo          String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  userAddress   String?
  user          User?         @relation(fields: [userAddress], references: [stellarAddress])
}

model Transfer {
  id            String         @id @default(uuid())
  txHash        String?        @unique
  fromUserId    String
  fromUser      User           @relation("TransfersFrom", fields: [fromUserId], references: [userId])
  toUserId      String
  toUser        User           @relation("TransfersTo", fields: [toUserId], references: [userId])
  amount        BigInt
  asset         String
  status        TransferStatus @default(PENDING)
  memo          String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Withdrawal {
  id                 String           @id @default(uuid())
  txHash             String?          @unique
  userId             String
  user               User             @relation(fields: [userId], references: [userId])
  destinationAddress String
  amount             BigInt
  asset              String
  status             WithdrawalStatus @default(PENDING)
  anchorTxId         String?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
}

model Balance {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [userId])
  asset       String
  amount      BigInt
  lastUpdated DateTime @default(now())

  @@unique([userId, asset])
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String
  actor      User     @relation(fields: [actorId], references: [userId])
  action     String
  resource   String
  resourceId String?
  metadata   Json?
  timestamp  DateTime @default(now())
  ipAddress  String?
  userAgent  String?
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [userId])
  type      NotificationType @default(SYSTEM)
  title     String
  message   String
  metadata  Json?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
}

model BridgeTransaction {
  id                 String                  @id @default(uuid())
  fromChain          String
  toChain            String
  asset              String
  amount             BigInt
  destinationAddress String
  userId             String
  status             BridgeTransactionStatus @default(PENDING)
  txHash             String?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
}

model ExternalAddress {
  id        String   @id @default(uuid())
  chain     String
  address   String
  userId    String
  user      User     @relation(fields: [userId], references: [userId])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([chain, address])
}
